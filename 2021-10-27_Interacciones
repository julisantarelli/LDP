with 
	conv as (
			select 
				uc.*, 
				u."role", 
				lead(uc."userId",1) over(partition by uc."conversationId") as "userId2",
				lead(u."role",1) over(partition by uc."conversationId") as "role2",
				concat(uc."userId",'-',lead(uc."userId",1) over(partition by uc."conversationId")) as "concatIds",
				concat(u."role",lead(u."role",1) over(partition by uc."conversationId")) as "concatRoles" 
			from public.users_conversations uc 
			left join public.users u on uc."userId" = u.id
	),
	conv_filter as (
			select 
				"concatIds","userId","userId2" as "targetUserId","role","role2" as "targetRole",1 as "metric_value",'conversation' as "metric_name"
			from conv
			where "concatRoles" in ('PLAYERCLUB','CLUBPLAYER','PLAYERAGENTE','AGENTEPLAYER')
	),
	shares as (
			select 
				i.*, 
				concat(i."userId",'-',i."targetUserId") as "concatIds",
				u."role" as "role", 
				u2."role" as "targetRole",
				concat(u."role",u2."role") as "concatRoles" 
			from public.users_shares i 
			left join public.users u on i."userId" = u.id
			left join public.users u2 on "targetUserId" = u2.id
	),
	shares_filter as (
			select 
				"concatIds","userId","targetUserId","role","targetRole",1 as "metric_value",'share' as "metric_name"
			from shares
			where "concatRoles" in ('CLUBPLAYER','AGENTPLAYER')
	),
	followers as (
			select 
				i.*,
				concat(i."userId",'-',i."targetUserId") as "concatIds", 
				u."role" as "role", 
				u2."role" as "targetRole",
				concat(u."role",u2."role") as "concatRoles" 
			from public.users_followers i 
			left join public.users u on i."userId" = u.id
			left join public.users u2 on "targetUserId" = u2.id
	),
	followers_filter as (
			select 
				"concatIds","userId","targetUserId","role","targetRole",1 as "metric_value",'follow' as "metric_name"
			from followers
			where "concatRoles" in ('CLUBPLAYER','AGENTPLAYER')
	),
	favourites as (
			select 
				i.*, 
				concat(i."userId",'-',i."targetUserId") as "concatIds",
				u."role" as "role", 
				u2."role" as "targetRole",
				concat(u."role",u2."role") as "concatRoles" 
			from public.users_favorites i 
			left join public.users u on i."userId" = u.id
			left join public.users u2 on "targetUserId" = u2.id
	),
	favourites_filter as(
			select 
				"concatIds","userId","targetUserId","role","targetRole",1 as "metric_value",'favourites' as "metric_name"
			from favourites
			where "concatRoles" in ('CLUBPLAYER','AGENTPLAYER')
	),
	likes as (
			select 
				i.*, 
				concat(i."userId",'-',i."targetUserId") as "concatIds",
				u."role" as "role", 
				u2."role" as "targetRole",
				concat(u."role",u2."role") as "concatRoles" 
			from public.users_likes i 
			left join public.users u on i."userId" = u.id
			left join public.users u2 on "targetUserId" = u2.id
	),
	likes_filter as (
			select 
				"concatIds","userId","targetUserId","role","targetRole",1 as "metric_value",'likes' as "metric_name"
			from likes
			where "concatRoles" in ('CLUBPLAYER','AGENTPLAYER') 
	),
	visits  as (
			select 
				i.*, 
				concat(i."userId",'-',i."targetUserId") as "concatIds",
				u."role" as "role", 
				u2."role" as "targetRole",
				concat(u."role",u2."role") as "concatRoles" 
			from public.users_visits i 
			left join public.users u on i."userId" = u.id
			left join public.users u2 on "targetUserId" = u2.id
	),
	visits_filter as (
			select 
				"concatIds","userId","targetUserId","role","targetRole",1 as "metric_value",'visits' as "metric_name"
			from visits
			where "concatRoles" in ('CLUBPLAYER','AGENTPLAYER') 
	),
	union_tables as(
			select * from conv_filter 
			union all
			select * from shares_filter 
			union all
			select * from followers_filter 
			union all
			select * from favourites_filter 
			union all
			select * from likes_filter
			union all
			select * from visits_filter)
		
			

select 
	"concatIds","userId","targetUserId","role","targetRole",
	SUM(CASE WHEN "metric_name" = 'conversation' THEN "metric_value" ELSE 0 END) AS "conversation",
	SUM(CASE WHEN "metric_name" = 'share' THEN "metric_value" ELSE 0 END) AS "share",
	SUM(CASE WHEN "metric_name" = 'follow' THEN "metric_value" ELSE 0 END) AS "follow",
	SUM(CASE WHEN "metric_name" = 'favourites' THEN "metric_value" ELSE 0 END) AS "favourites",
	SUM(CASE WHEN "metric_name" = 'likes' THEN "metric_value" ELSE 0 END) AS "likes",
	SUM(CASE WHEN "metric_name" = 'visits' THEN "metric_value" ELSE 0 END) AS "visits"
FROM union_tables GROUP BY 1,2,3,4,5



    
    





	




	







	




	


